mode: single
max_exceeded: silent

blueprint:
  name: Marstek X on the Meter
  description: Control a Marstek Battery according to a grid sensor
  author: PimDoos
  domain: automation

  input:
    grid_entity:
      name: Grid
      description: Entity measuring grid net consumption
      selector:
        entity:
          filter:
            domain: sensor
            device_class: power

    battery_device:
      name: Battery
      description: Marstek Battery devices to control
      selector:
        device:
          filter:
            integration: esphome
          multiple: true

    setpoint_smoothing_value:
      name: Smoothing value
      description: Maximum delta between two setpoints. This should not be lower than the Minimum Power of the battery.
      default: 100
      selector:
        number:
          min: 50
          max: 2500

    setpoint_optimal_value:
      name: Max optimal power
      description: Amount of power required before loadbalancing to more batteries
      default: 2000
      selector:
        number:
          min: 50
          max: 2500

    setpoint_min:
      name: Minimum power setpoint
      description: Minimum total setpoint for all batteries combined. If this is 0 or higher, charging is disabled.
      default: -12000
      selector:
        number:
          min: -12000
          max: 12000
          mode: box

    setpoint_max:
      name: Maximum power setpoint
      description: Minimum total setpoint for all batteries combined. If this is 0 or lower, discharging is disabled.
      default: 12000
      selector:
        number:
          min: -12000
          max: 12000
          mode: box

    setpoint_target_value:
      name: Target value
      description: Target value (X) for the Grid entity
      default: 0
      selector:
        number:
          min: -5000
          max: 5000
          mode: box

    offset_entity:
      name: Offset entities
      description: Entities whose value (in Watts) should be subtracted from the grid sensor. E.g. Car charger power sensor
      default: []
      selector:
        entity:
          multiple: true
          filter:
            domain:
              - sensor
              - number
              - input_number

    update_interval:
      name: Update interval
      description: Time to wait before accepting new data from the grid sensor
      selector:
        duration:

    update_timeout:
      name: Update timeout
      description: Maximum time to wait for new data from the grid sensor
      selector:
        duration:

    battery_soc_min:
      name: Minimum State of Charge
      description: Batteries below this level will not participate in the load balancing pool
      default: 0
      selector:
        number:
          min: 0
          max: 99

    battery_soc_max:
      name: Maximum State of Charge
      description: Batteries above this level will not participate in the load balancing pool
      default: 100
      selector:
        number:
          min: 1
          max: 100

    priority_offset_template:
      name: Priority offset template
      description: Template defining a value to rotate battery priority by. Values higher than the number of batteries will loop back to 0.
      default: "{{ now().day }}"
      selector:
        template:

variables:
  device_ids: !input battery_device
  optimal_max_power: !input setpoint_optimal_value
  grid_entity: !input grid_entity
  smoothing: !input setpoint_smoothing_value
  offset: !input setpoint_target_value
  offset_entity: !input offset_entity
  min_battery_level: !input battery_soc_min
  max_battery_level: !input battery_soc_max
  min_setpoint: !input setpoint_min
  max_setpoint: !input setpoint_max

trigger:
  - trigger: state
    entity_id: !input grid_entity
  - trigger: homeassistant
    event: start

action:
  - variables:
      device_ids: >
        {% if device_ids is string %}{% set device_ids = [ device_ids ] %}{% endif %}
        {{ device_ids }}
      battery_count: >
        {{ device_ids | count }}
      priority_offset_template: !input priority_offset_template
      priority_offset: >
        {{ priority_offset_template % battery_count }}

  - variables:
      # Get Entity IDs from device IDs
      battery_rs485_control_entity: >
        {% set entities = namespace(rs485_control=[]) %}
        {% for device_id in device_ids %}
          {% set entities.rs485_control = entities.rs485_control + [device_entities(device_id) | list | select("search","_rs485_control_mode$") | list | join("")] %}
        {% endfor %}
        {{ entities.rs485_control[priority_offset:] + entities.rs485_control[:priority_offset] }}

      battery_mode_entity: >
        {% set entities = namespace(mode=[]) %}
        {% for device_id in device_ids %}
          {% set entities.mode = entities.mode + [device_entities(device_id) | list | select("search","_forcible_charge_discharge$") | list | join("")] %}
        {% endfor %}
        {{ entities.mode[priority_offset:] + entities.mode[:priority_offset] }}
        
      battery_acpower_entity: >
        {% set entities = namespace(acpower=[]) %}
        {% for device_id in device_ids %}
        {% set entities.acpower = entities.acpower + [device_entities(device_id) | list | select("search","_ac_power$") | list | join("")] %}
        {% endfor %}
        {{ entities.acpower[priority_offset:] + entities.acpower[:priority_offset] }}

      battery_setpointcharge_entity: >
        {% set entities = namespace(setpointcharge=[]) %}
        {% for device_id in device_ids %}
          {% set entities.setpointcharge = entities.setpointcharge + [device_entities(device_id) | list | select("search","_forcible_charge_power$") | list | join("")] %}
        {% endfor %}
        {{ entities.setpointcharge[priority_offset:] + entities.setpointcharge[:priority_offset] }}

      battery_setpointdischarge_entity: >
        {% set entities = namespace(setpointdischarge=[]) %}
        {% for device_id in device_ids %}
          {% set entities.setpointdischarge = entities.setpointdischarge + [device_entities(device_id) | list | select("search","_forcible_discharge_power$") | list | join("")] %}
        {% endfor %}
        {{ entities.setpointdischarge[priority_offset:] + entities.setpointdischarge[:priority_offset] }}

      battery_soc_entity: >
        {% set entities = namespace(soc=[]) %}
        {% for device_id in device_ids %}
          {% set entities.soc = entities.soc + [device_entities(device_id) | list | select("search","_state_of_charge$") | list | join("")] %}
        {% endfor %}
        {{ entities.soc[priority_offset:] + entities.soc[:priority_offset] }}

      # Get grid power and convert to Watts
      grid: >
        {% set grid_unit = state_attr(grid_entity, "unit_of_measurement") %}
        {% set multiplier = 1 if grid_unit == "W" else 1000 if grid_unit == "kW" else 1 %}
        {% set grid_power = states(grid_entity) | float %}
        {{ grid_power * multiplier }}

  - variables:
      battery: >
        {{  battery_acpower_entity | map("states") | list | map('int') | sum }}
      offset: >
        {% if offset_entity is string %}{% set offset_entity = [offset_entity] %}{% endif %}
        {% set offset = offset + offset_entity | map("states") | map("int") | sum %}
        {{ offset }}
      setpoint: >
        {% set load = battery + grid %}
        {% set setpoint_target = load - offset %}
        {% set lower = [setpoint_target, battery - smoothing, min_setpoint] | max %}
        {% set setpoint_smooth = [lower, battery + smoothing, max_setpoint] | min %}
        {{ setpoint_smooth }}

  - variables:
      battery_setpoints: >
        {% set num_optimal = ((setpoint | abs) / optimal_max_power) | round(0,'ceil') %}
        {% set batteries = namespace(entities=[], available=[], standby=[]) %}
        {% for i in range(0,battery_count) %}
          {% if batteries.available | count < num_optimal 
             and states(battery_rs485_control_entity[i]) == "enable"
             and (states(battery_soc_entity[i]) | int >= min_battery_level or setpoint < 0)
             and (states(battery_soc_entity[i]) | int <= max_battery_level or setpoint > 0) %}
            {% set batteries.available = batteries.available + [i] %}
          {% else %}
            {% set batteries.standby = batteries.standby + [i] %}
          {% endif %}
        {% endfor %}
        {% set divisor = (batteries.available | count) if (batteries.available | count) > 0 else 1 %}
        {% for i in batteries.available %}
          {% set value = (setpoint / divisor) | int %}
          {% set value = [[value, -2200] | max, 2200] | min %}
          {% set batteries.entities = batteries.entities + [{
            "setpointcharge": battery_setpointcharge_entity[i],
            "setpointdischarge": battery_setpointdischarge_entity[i],
            "rs485_control": battery_rs485_control_entity[i],
            "mode": battery_mode_entity[i],
            "value": value
          }] %}
        {% endfor %}
        {% for i in batteries.standby %}
          {% set batteries.entities = batteries.entities + [{
            "setpointcharge": battery_setpointcharge_entity[i],
            "setpointdischarge": battery_setpointdischarge_entity[i],
            "rs485_control": battery_rs485_control_entity[i],
            "mode": battery_mode_entity[i],
            "value": 0
          }] %}
        {% endfor %}
        {{ batteries.entities }}

  # --- Negatieve setpoints (laden) ---
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ battery_setpoints | selectattr('value','lt',0) | list | count > 0 }}
        sequence:
          - repeat:
              for_each: >
                {{ battery_setpoints | selectattr('value','lt',0) | list }}
              sequence:
                - condition: template
                  value_template: >
                    {{ states(repeat.item.rs485_control) == "enable" }}
                - action: select.select_option
                  target:
                    entity_id: >
                      {{ repeat.item.mode }}
                  data:
                    option: charge
                - action: number.set_value
                  continue_on_error: true
                  target:
                    entity_id: >
                      {{ repeat.item.setpointcharge }}
                  data:
                    # negatief setpoint omzetten in positief
                    value: >
                      {{ repeat.item.value | abs | int }}
                - action: number.set_value
                  continue_on_error: true
                  target:
                    entity_id: >
                      {{ repeat.item.setpointdischarge }}
                  data:
                    # ander setpoint wissen
                    value: 0

  # --- Positieve setpoints (ontladen) ---
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ battery_setpoints | selectattr('value','gt',0) | list | count > 0 }}
        sequence:
          - repeat:
              for_each: >
                {{ battery_setpoints | selectattr('value','gt',0) | list }}
              sequence:
                - condition: template
                  value_template: >
                    {{ states(repeat.item.rs485_control) == "enable" }}
                - action: select.select_option
                  target:
                    entity_id: >
                      {{ repeat.item.mode }}
                  data:
                    option: discharge
                - action: number.set_value
                  continue_on_error: true
                  target:
                    entity_id: >
                      {{ repeat.item.setpointdischarge }}
                  data:
                    value: >
                      {{ repeat.item.value | int }}
                - action: number.set_value
                  continue_on_error: true
                  target:
                    entity_id: >
                      {{ repeat.item.setpointcharge }}
                  data:
                    value: 0

                      

  - delay: !input update_interval
