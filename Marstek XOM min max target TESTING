mode: single
max_exceeded: silent

blueprint:
  name: Marstek X on the Meter
  description: Control a Marstek Battery according to a grid sensor
  author: Tazzios (Based on PimDoos`s works)
  domain: automation

  input:
    grid_entity:
      name: Grid
      description: Entity measuring grid net consumption
      selector:
        entity:
          filter:
            domain: sensor
            device_class: power

    battery_device:
      name: Battery
      description: Marstek Battery devices to control
      selector:
        device:
          filter:
            integration: esphome
          multiple: true

    setpoint_smoothing_value:
      name: Smoothing value
      description: Maximum delta between two setpoints. This should not be lower than the Minimum Power of the battery.
      default: 100
      selector:
        number:
          min: 50
          max: 2500

    setpoint_optimal_value:
      name: Max optimal power
      description: Amount of power required before loadbalancing to more batteries
      default: 2000
      selector:
        number:
          min: 50
          max: 2500

    setpoint_min:
      name: Minimum power setpoint
      description: Minimum total setpoint for all batteries combined. If this is 0 or higher, charging is disabled.
      default: -12000
      selector:
        number:
          min: -12000
          max: 12000
          mode: box

    setpoint_max:
      name: Maximum power setpoint
      description: Minimum total setpoint for all batteries combined. If this is 0 or lower, discharging is disabled.
      default: 12000
      selector:
        number:
          min: -12000
          max: 12000
          mode: box

    setpoint_target_min:
      name: Target minimum value
      description: Lower limit for the Grid target band (in Watts)
      default: -200
      selector:
        number:
          min: -5000
          max: 5000
          mode: box

    setpoint_target_max:
      name: Target maximum value
      description: Upper limit for the Grid target band (in Watts)
      default: 200
      selector:
        number:
          min: -5000
          max: 5000
          mode: box

    offset_entity:
      name: Offset entities
      description: Entities whose value (in Watts) should be subtracted from the grid sensor. E.g. Car charger power sensor
      default: []
      selector:
        entity:
          multiple: true
          filter:
            domain:
              - sensor
              - number
              - input_number

    update_interval:
      name: Update interval
      description: Time to wait before accepting new data from the grid sensor
      selector:
        duration:

    update_timeout:
      name: Update timeout
      description: Maximum time to wait for new data from the grid sensor
      selector:
        duration:

    battery_soc_min:
      name: Minimum State of Charge
      description: Batteries below this level will not participate in the load balancing pool
      default: 0
      selector:
        number:
          min: 0
          max: 99

    battery_soc_max:
      name: Maximum State of Charge
      description: Batteries above this level will not participate in the load balancing pool
      default: 100
      selector:
        number:
          min: 1
          max: 100

    priority_offset_template:
      name: Priority offset template
      description: Template defining a value to rotate battery priority by. Values higher than the number of batteries will loop back to 0.
      default: "{{ now().day }}"
      selector:
        template:

variables:
  device_ids: !input battery_device
  optimal_max_power: !input setpoint_optimal_value
  grid_entity: !input grid_entity
  smoothing: !input setpoint_smoothing_value
  target_min: !input setpoint_target_min
  target_max: !input setpoint_target_max
  offset_entity: !input offset_entity
  min_battery_level: !input battery_soc_min
  max_battery_level: !input battery_soc_max
  min_setpoint: !input setpoint_min
  max_setpoint: !input setpoint_max

trigger:
  - trigger: state
    entity_id: !input grid_entity
  - trigger: homeassistant
    event: start

action:
  - variables:
      device_ids: >
        {% if device_ids is string %}{% set device_ids = [ device_ids ] %}{% endif %}
        {{ device_ids }}
      battery_count: >
        {{ device_ids | count }}
      priority_offset_template: !input priority_offset_template
      priority_offset: >
        {{ priority_offset_template % battery_count }}

  - variables:
      # Get Entity IDs from device IDs
      battery_rs485_control_entity: >
        {% set entities = namespace(rs485_control=[]) %}
        {% for device_id in device_ids %}
          {% set entities.rs485_control = entities.rs485_control + [device_entities(device_id) | list | select("search","_rs485_control_mode$") | list | join("")] %}
        {% endfor %}
        {{ entities.rs485_control[priority_offset:] + entities.rs485_control[:priority_offset] }}

      battery_mode_entity: >
        {% set entities = namespace(mode=[]) %}
        {% for device_id in device_ids %}
          {% set entities.mode = entities.mode + [device_entities(device_id) | list | select("search","_forcible_charge_discharge$") | list | join("")] %}
        {% endfor %}
        {{ entities.mode[priority_offset:] + entities.mode[:priority_offset] }}
        
      battery_acpower_entity: >
        {% set entities = namespace(acpower=[]) %}
        {% for device_id in device_ids %}
        {% set entities.acpower = entities.acpower + [device_entities(device_id) | list | select("search","_ac_power$") | list | join("")] %}
        {% endfor %}
        {{ entities.acpower[priority_offset:] + entities.acpower[:priority_offset] }}

      battery_setpointcharge_entity: >
        {% set entities = namespace(setpointcharge=[]) %}
        {% for device_id in device_ids %}
          {% set entities.setpointcharge = entities.setpointcharge + [device_entities(device_id) | list | select("search","_forcible_charge_power$") | list | join("")] %}
        {% endfor %}
        {{ entities.setpointcharge[priority_offset:] + entities.setpointcharge[:priority_offset] }}

      battery_setpointdischarge_entity: >
        {% set entities = namespace(setpointdischarge=[]) %}
        {% for device_id in device_ids %}
          {% set entities.setpointdischarge = entities.setpointdischarge + [device_entities(device_id) | list | select("search","_forcible_discharge_power$") | list | join("")] %}
        {% endfor %}
        {{ entities.setpointdischarge[priority_offset:] + entities.setpointdischarge[:priority_offset] }}

      battery_soc_entity: >
        {% set entities = namespace(soc=[]) %}
        {% for device_id in device_ids %}
          {% set entities.soc = entities.soc + [device_entities(device_id) | list | select("search","_state_of_charge$") | list | join("")] %}
        {% endfor %}
        {{ entities.soc[priority_offset:] + entities.soc[:priority_offset] }}

      # Get grid power and convert to Watts
      grid: >
        {% set grid_unit = state_attr(grid_entity, "unit_of_measurement") %}
        {% set multiplier = 1 if grid_unit == "W" else 1000 if grid_unit == "kW" else 1 %}
        {% set grid_power = states(grid_entity) | float %}
        {{ grid_power * multiplier }}

  - variables:
      battery: >
        {{  battery_acpower_entity | map("states") | list | map('int') | sum }}
      offset_total: >
        {% if offset_entity is string %}{% set offset_entity = [offset_entity] %}{% endif %}
        {{ offset_entity | map("states") | map("int") | sum }}

      setpoint: >
        {% set net_load = grid - offset_total %}
        {% if net_load < target_min %}
          {# te veel export -> laad batterij #}
          {% set target_diff = net_load - target_min %}
        {% elif net_load > target_max %}
          {# te veel import -> ontlaad batterij #}
          {% set target_diff = net_load - target_max %}
        {% else %}
          {% set target_diff = 0 %}
        {% endif %}

        {% set lower = [target_diff, battery - smoothing, min_setpoint] | max %}
        {% set setpoint_smooth = [lower, battery + smoothing, max_setpoint] | min %}
        {{ setpoint_smooth }}

  - variables:
      battery_setpoints: >
        {% set num_optimal = ((setpoint | abs) / optimal_max_power) | round(0,'ceil') %}
        {% set batteries = namespace(entities=[], available=[], standby=[]) %}
        {% for i in range(0,battery_count) %}
          {% if batteries.available | count < num_optimal 
             and states(battery_rs485_control_entity[i]) == "enable"
             and (states(battery_soc_entity[i
